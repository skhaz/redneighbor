<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="description" content="Introducing Lollipop, a sweet new take on Android.">
    <meta http-equiv="Content-Language" content="pt-br">
    <title>Manda Nudes AÃª!</title>

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:regular,bold,italic,thin,light,bolditalic,black,medium&amp;lang=en">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.2.1/material.min.css">

    <link rel="stylesheet" href="https://code.getmdl.io/1.2.1/material.red-pink.min.css" />
    <!-- <link rel="stylesheet" href="styles.css"> -->
    <style>

    #view-source {
      position: fixed;
      display: block;
      right: 0;
      bottom: 0;
      margin-right: 40px;
      margin-bottom: 40px;
      z-index: 900;
    }

    #map {
      width: auto;
      /*500px;*/
      /*height: 400px;*/
      /*height:100vh;*/
      height: 100%;
      overflow: hidden;
      max-width: none;
      /*background-color: #CCC;*/
    }

    .mdl-layout__content {
      height: 100vh;
    }
    </style>
  </head>
  <body>
    <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">

      <div class="android-header mdl-layout__header mdl-layout__header--waterfall">
        <div class="mdl-layout__header-row">
          <span class="android-title mdl-layout-title">
            <!-- <img class="android-logo-image" src="images/android-logo.png"> -->
          </span>
          <!-- Add spacer, to align navigation to the right in desktop -->
          <div class="android-header-spacer mdl-layout-spacer"></div>
          <div class="mdl-textfield mdl-js-textfield mdl-textfield--expandable mdl-textfield--floating-label mdl-textfield--align-right mdl-textfield--full-width">
          </div>
          <!-- Navigation -->
          <div class="android-navigation-container">
            <nav class="android-navigation mdl-navigation">
              <a class="mdl-navigation__link mdl-typography--text-uppercase" href="/">Mapa</a>
              <!-- <a class="mdl-navigation__link mdl-typography--text-uppercase" href="">Proximos</a> -->
              <a class="mdl-navigation__link mdl-typography--text-uppercase" href="/upload">Enviar</a>
            </nav>
          </div>

          <!--
          <span class="android-mobile-title mdl-layout-title">
            <img class="android-logo-image" src="images/android-logo.png">
          </span>
          <button class="android-more-button mdl-button mdl-js-button mdl-button--icon mdl-js-ripple-effect" id="more-button">
            <i class="material-icons">more_vert</i>
          </button>
          <ul class="mdl-menu mdl-js-menu mdl-menu--bottom-right mdl-js-ripple-effect" for="more-button">
            <li class="mdl-menu__item">5.0 Lollipop</li>
            <li class="mdl-menu__item">4.4 KitKat</li>
            <li disabled class="mdl-menu__item">4.3 Jelly Bean</li>
            <li class="mdl-menu__item">Android History</li>
          </ul>
        -->

        </div>
      </div>

<!--
      <div class="android-drawer mdl-layout__drawer">
        <span class="mdl-layout-title">
          <img class="android-logo-image" src="images/android-logo-white.png">
        </span>
        <nav class="mdl-navigation">
          <a class="mdl-navigation__link map-tab" href="/">Mapa</a>
          <a class="mdl-navigation__link" href="/upload">Enviar</a>
        </nav>
      </div>
-->

      <main class="mdl-layout__content">
        <div id="map"></div>
      </main>

        <footer class="android-footer mdl-mega-footer">
          <!--
          <div class="mdl-mega-footer--top-section">
            <div class="mdl-mega-footer--left-section">
              <button class="mdl-mega-footer--social-btn"></button>
              &nbsp;
              <button class="mdl-mega-footer--social-btn"></button>
              &nbsp;
              <button class="mdl-mega-footer--social-btn"></button>
            </div>
          </div>
        -->

          <div class="mdl-mega-footer--middle-section">
            <p class="mdl-typography--font-light">Some features and devices may not be available in all areas</p>
          </div>

          <div class="mdl-mega-footer--bottom-section">
            <a class="android-link mdl-typography--font-light" href="">Privacy Policy</a>
          </div>

        </footer>
      </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/3.5.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.5.2/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.5.2/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.5.2/firebase-messaging.js"></script>
    <script>
    var config = {
      apiKey: "AIzaSyBmhEGzwL4wVUcGn6ZZiHBD_Aq0gOgCSaU",
      authDomain: "redneighbor-b.firebaseapp.com",
      storageBucket: "redneighbor-b.appspot.com",
      messagingSenderId: "787208033873"
    };

    firebase.initializeApp(config);

    var auth = firebase.auth();

    auth.onAuthStateChanged(function(user) {
      if (user) {
        var isAnonymous = user.isAnonymous;
        var uid = user.uid;

        console.log(user, isAnonymous);
      } else {
        console.log("User is signed out.");
      }
    });

    function initMap() {
      google.maps.event.addDomListener(window, 'load', function() {
        var markers = [];
        var infowindow = new google.maps.InfoWindow();
        var map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: -14.2350, lng: -51.9253},
          zoom: 3,
          disableDefaultUI: true
        });

        function addMarker(nude) {
          var location = new google.maps.LatLng(nude.lat, nude.lng)
          var marker = new google.maps.Marker({
            position: location,
            map: map,
            // anchorPoint: new google.maps.Point(x, y),
            data: nude
          });

          google.maps.event.addListener(marker, 'click', function() {
            //map.setCenter(new google.maps.LatLng(marker.position.lat(), marker.position.lng()));
            //map.setZoom(18);
            // onItemClick(event, pinMarker);
            var contentString = "<img style='width:128px;height:128px;' src='"+  marker.data.url + "'>";

            // Replace our Info Window's content and position
            infowindow.setContent(contentString);
            infowindow.setPosition(marker.position);
            infowindow.open(map)
          });
          markers.push(marker);
        }

        function setMapOnAll(map) {
          for (var i = 0; i < markers.length; i++) {
            markers[i].setMap(map);
          }
        }

        function clearMarkers() {
          setMapOnAll(null);
        }

        function showMarkers() {
          setMapOnAll(map);
        }

        function deleteMarkers() {
          clearMarkers();
          markers = [];
        }

        google.maps.event.addListener(map, 'idle', function() {
          var center = map.getCenter();
          var lat = 1;
          var lng = 1;
          var distance = 999999999;
          var limit = 1000;

          var url = 'https://redneighbor-b.appspot.com/api/v1/nudes' +
            '?lat=' + lat +
            '&lng=' + lng +
            '&distance=' + distance +
            '&limit=' + limit +
            '&offset=' + 0;

          var request = new XMLHttpRequest();
          request.open('GET', url, true);
          request.onload = function() {
            if (request.status >= 200 && request.status < 400) {
              var payload = JSON.parse(request.responseText);

              if (!payload || !payload.nudes) {
                return;
              }

              deleteMarkers();
              payload.nudes.forEach(function(nude) { addMarker(nude) }, this);
              showMarkers();
            } else {

            }
          };

          request.onerror = function() {
            console.log('request.onerror');
          };

          request.send();
        });

        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            var pos = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };

            map.setCenter(pos);
            map.setZoom(10);
          });
        }
      });
    }
    </script>

    <script src="https://code.getmdl.io/1.2.1/material.min.js"></script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?callback=initMap&key=AIzaSyAoMXjq-vmAOzoJVt8UCBppNaZar2ciy24"></script>
  </body>
</html>
