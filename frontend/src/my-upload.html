<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../bower_components/polymerfire/firebase-storage-script.html">
<link rel="import" href="../bower_components/polymerfire/firebase-common-behavior.html">

<link rel="import" href="shared-styles.html">

<dom-module id="my-upload">
  <template>
    <style include="shared-styles iron-flex iron-positioning iron-flex-alignment">
      :host {
        display: block;

        padding: 10px;
      }

      #example-sizing-contain {
        width: 480px;
        height: 480px;
        background: #ddd;
      }

      #tags {
        width: 480px;
        --paper-input-container-focus-color: #F44336;
      }

      .flex-center-justified {
        @apply(--layout-horizontal);
        @apply(--layout-center-justified);
      }

      .flex-vertical {
        @apply(--layout-vertical);
      }

      .flexchild {
        @apply(--layout-flex);
      }

      .flex-end-justified {
        @apply(--layout-horizontal);
        @apply(--layout-end-justified);
      }

      .container.small { width: 120px; }

    </style>

    <style is="custom-style" include="iron-flex iron-positioning iron-flex-alignment">
      .card-container {
        height: 100%;
      }
    </style>

    <input id="input"
      type="file"
      accept="image/jpeg, image/png"
      on-change="_uploadNude"
      style="position: fixed; top: -100em">

      <div class="container flex-vertical">
        <div class="flex-center-justified">
          <iron-image preload fade sizing="contain" id="example-sizing-contain" alt="" src="http://1.bp.blogspot.com/-061rfx8vCE0/UyDl3tqFy6I/AAAAAAAABYY/7vX21txgwcM/s1600/bunda.jpg"></iron-image>
        </div>

        <div class="flex-center-justified">
          <paper-input id="tags" label="tags"></paper-input>
        </div>

        <div class="flex-center-justified">
          <paper-button raised on-tap="_uploadNude">enviar</paper-button>
        </div>
      </div>

      <!--
      <div class="horizontal layout center-justified card-container">
      <div class="vertical layout center-justified">
          <paper-card image="http://placehold.it/480x480" alt="">

            <div class="card-content">
              <paper-input label="tags"></paper-input>
            </div>

            <div class="card-actions">
              <paper-button>Publicar</paper-button>
            </div>
          </paper-card>

        </div>
      </div>
      -->

      <iron-meta id="meta" key="user" value="{{user}}"></iron-meta>

  </template>

  <script>
    Polymer({
      is: 'my-upload',

      ready: function() {
        // this.storageRef = firebase.storage().ref();
        this.$.input.click();
      },

      properties: {
        storageRef: {
          type: Object,
        },

        statusKnown: {
          type: Boolean,
          value: false,
          notify: true,
          readOnly: true,
        },

        active: {
          type: Boolean,
          notify: true,
          computed: '_computeActive(statusKnown, token)',
        },
      },

      _computeActive: function(statusKnown, token) {
        return !!(statusKnown && signedIn);
      },

      _uploadNude: function(event, detail, sender) {
        var user = this.$.meta.byKey('user');
        var uid = user.uid;
        var file = event.target.files[0];

        var now = new Date();
        var year = now.getUTCFullYear();
        var month = now.getUTCMonth() + 1;
        var day = now.getUTCDate();
        var p1 = uid.slice(0, 3);
        var filename = file.name.replace(/[^A-Z0-9]+/ig, "-");
        var path = [year, month, day, p1, filename].join("/");

        var metadata = {
          contentType: file.type,
          customMetadata: {
            user: uid
          }
        };

        this.$.dialog.open();
        var img = this.$.image;

        this.storageRef.child(path).put(file, metadata).then(function(snapshot) {
          console.log('Uploaded', snapshot.totalBytes, 'bytes.');
          console.log(snapshot.metadata);
          var url = snapshot.metadata.downloadURLs[0];
          console.log('File available at', url);

          // TODO use properties
          img.src = url;
          // alert(uid);
          // Open dialog and show preview
          // document.getElementById('linkbox').innerHTML = '<a href="' +  url + '">Click For File</a>';
        }).catch(function(error) {
          console.error('Upload failed:', error);
          alert(error);
        });
      },


    });
  </script>
</dom-module>
